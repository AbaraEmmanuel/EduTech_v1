<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaroMind - Explore Courses</title>
    <link rel="stylesheet" href="notification.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="courses.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Additional inline styles for animations */
        .course-card {
            animation: fadeInUp 0.6s ease forwards;
            opacity: 0;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-header {
            position: relative;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }
    </style>
</head>
<body class="light-mode">

    <nav class="navbar">
        <div class="navbar-left">
            <img src="ht9.png" class="logo_img">
            <a href="index.html" class="nav-link">JaroMind</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="courses.html" class="nav-link active">Courses</a>
        </div>
        <div class="navbar-right">
            <button class="mode-toggle" id="modeToggle">ðŸŒž</button>
            <div class="user-menu" id="userMenu" style="display: none;">
                <div class="user-avatar">
                    <img id="userAvatar" src="" alt="User Avatar" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
                    <span id="avatarInitial">U</span>
                </div>
                <div class="user-info">
                    <div class="user-name">Guest</div>
                    <div id="userEmail" style="font-size: 0.8rem; opacity: 0.7;"></div>
                </div>
                <button class="btn-outline btn-small" onclick="window.location.href='sign_in.html'">Login</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="courses-header">
            <h1><span class="gradient-text">Explore Our Courses</span></h1>
            <p>Choose from complete class curricula or focus on specific subjects. Start your learning journey today!</p>
        </div>

        <!-- Course Stats -->
        <div class="course-stats">
            <div class="stat-card">
                <i class="fas fa-book-open"></i>
                <div>
                    <h3 id="totalCourses">0</h3>
                    <p>Total Courses</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-graduation-cap"></i>
                <div>
                    <h3 id="freeCourses">0</h3>
                    <p>Free Courses</p>
                </div>
            </div>
            <!-- <div class="stat-card">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h3 id="activeStudents">0</h3>
                    <p>Active Students</p>
                </div>
            </div> -->
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">
                <i class="fas fa-th-large"></i> All Courses
            </button>
            <button class="filter-tab" data-filter="class">
                <i class="fas fa-graduation-cap"></i> Class Lessons
            </button>
            <button class="filter-tab" data-filter="subject">
                <i class="fas fa-book-open"></i> Subject Lessons
            </button>
            <button class="filter-tab" data-filter="free">
                <i class="fas fa-gift"></i> Free Courses
            </button>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="courseSearch" placeholder="Search courses...">
            </div>
        </div>

        <!-- High School Class Lessons Section -->
        <div class="section-header">
            <h2><i class="fas fa-university"></i> High School Class Lessons</h2>
        </div>
        <div class="courses-grid" id="classCoursesContainer">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading class courses...</p>
            </div>
        </div>

        <!-- Subjects Lessons Section -->
        <div class="section-header">
            <h2><i class="fas fa-atom"></i> Subjects Lessons</h2>
        </div>
        <div class="courses-grid" id="subjectCoursesContainer">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading subject courses...</p>
            </div>
        </div>

        <!-- Call to Action -->
        <div class="cta-section glass-effect">
            <div class="cta-content">
                <h2>Ready to Master Your Subjects?</h2>
                <p>Join thousands of students who are already learning with JaroMind</p>
                <div class="cta-buttons">
                    <a href="sign_up.html" class="btn-primary btn-large btn-glow">
                        <i class="fas fa-rocket"></i> Start Free Trial
                    </a>
                    <a href="#featured" class="btn-outline btn-large">
                        <i class="fas fa-play-circle"></i> View Demo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Details Modal (From Old Page) -->
    <div id="courseModal" class="course-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="course-modal-backdrop" id="modalBackdrop"></div>
        <div class="course-modal-panel" role="document" aria-labelledby="modalTitle">
            <button class="modal-close" id="modalCloseBtn" aria-label="Close details">&times;</button>
            <div class="modal-header">
                <div class="modal-image" id="modalImage"></div>
                <div class="modal-headline">
                    <h2 id="modalTitle">Course Title</h2>
                    <p id="modalSubtitle" class="muted">Course subtitle / summary</p>
                </div>
            </div>

            <div class="modal-body">
                <div class="modal-meta">
                    <span id="modalLessons"><i class="fas fa-play-circle"></i> 0 Lessons</span>
                    <span id="modalDuration"><i class="fas fa-clock"></i> 0h</span>
                    <span id="modalLevel"><i class="fas fa-user-graduate"></i> Level</span>
                    <span id="modalPrice" class="modal-price"></span>
                </div>

                <!-- Tabs -->
                <div class="modal-tabs" role="tablist" aria-label="Course sections">
                    <button class="tab-btn active" role="tab" aria-selected="true" data-tab="overview">Overview</button>
                    <button class="tab-btn" role="tab" aria-selected="false" data-tab="curriculum">Curriculum</button>
                    <button class="tab-btn" role="tab" aria-selected="false" data-tab="instructor">Instructor</button>
                    <button class="tab-btn" role="tab" aria-selected="false" data-tab="reviews">Reviews</button>
                </div>

                <div class="tab-panels">
                    <div class="tab-panel active" data-panel="overview" role="tabpanel">
                        <div id="panelOverview">Loading overviewâ€¦</div>
                    </div>
                    <div class="tab-panel" data-panel="curriculum" role="tabpanel" hidden>
                        <div id="panelCurriculum">Loading curriculumâ€¦</div>
                    </div>
                    <div class="tab-panel" data-panel="instructor" role="tabpanel" hidden>
                        <div id="panelInstructor">Loading instructor informationâ€¦</div>
                    </div>
                    <div class="tab-panel" data-panel="reviews" role="tabpanel" hidden>
                        <div id="panelReviews">Loading reviewsâ€¦</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-outline" onclick="closeModal()">Close</button>
                <a href="#" id="modalAction" class="btn-primary">
                    <i class="fas fa-play-circle"></i> Start Learning
                </a>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://jaromind-production-014b.up.railway.app';
        
        // Global variables
        let allCourses = [];
        let filteredCourses = [];
        let user = null;

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Theme Management
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            document.body.className = savedTheme;
            updateModeIcon(savedTheme);

            // Mode toggle
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle) {
                modeToggle.addEventListener('click', toggleTheme);
            }

            // Check if user is logged in
            checkAuthStatus();

            // Setup filter tabs
            setupFilterTabs();

            // Setup search
            setupSearch();

            // Load courses
            loadCoursesFromAPI();

            // Initialize stats
            updateStats();
        });

        // Theme functions
        function toggleTheme() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.replace('light-mode', 'dark-mode');
                localStorage.setItem('theme', 'dark-mode');
                updateModeIcon('dark-mode');
            } else {
                document.body.classList.replace('dark-mode', 'light-mode');
                localStorage.setItem('theme', 'light-mode');
                updateModeIcon('light-mode');
            }
        }

        function updateModeIcon(theme) {
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle) {
                modeToggle.textContent = theme === 'dark-mode' ? 'ðŸŒ™' : 'ðŸŒž';
            }
        }

        // Check authentication status
        function checkAuthStatus() {
            const userData = localStorage.getItem('user');
            if (userData) {
                user = JSON.parse(userData);
                const userMenu = document.getElementById('userMenu');
                if (userMenu) {
                    userMenu.style.display = 'flex';
                    document.querySelector('.user-name').textContent = user.name || 'User';
                    document.getElementById('userEmail').textContent = user.email || '';
                }
            }
        }

        // Filter tabs
        function setupFilterTabs() {
            const tabs = document.querySelectorAll('.filter-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Filter courses
                    const filter = tab.dataset.filter;
                    filterCourses(filter);
                });
            });
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('courseSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    if (searchTerm) {
                        filteredCourses = allCourses.filter(course => 
                            course.title.toLowerCase().includes(searchTerm) ||
                            course.description.toLowerCase().includes(searchTerm) ||
                            (course.subject && course.subject.toLowerCase().includes(searchTerm)) ||
                            (course.class_level && course.class_level.toLowerCase().includes(searchTerm))
                        );
                    } else {
                        const activeTab = document.querySelector('.filter-tab.active');
                        const filter = activeTab ? activeTab.dataset.filter : 'all';
                        filterCourses(filter);
                    }
                    renderCourses();
                }, 300));
            }
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Filter courses
        function filterCourses(filter) {
            if (filter === 'all') {
                filteredCourses = [...allCourses];
            } else if (filter === 'free') {
                filteredCourses = allCourses.filter(course => !course.price || course.price === 0);
            } else if (filter === 'class') {
                filteredCourses = allCourses.filter(course => course.type === 'class' || course.class_level);
            } else if (filter === 'subject') {
                filteredCourses = allCourses.filter(course => course.type === 'subject' || course.subject);
            }
            
            // Update search input
            const searchInput = document.getElementById('courseSearch');
            if (searchInput) searchInput.value = '';
            
            renderCourses();
        }

        // Load courses from API
        async function loadCoursesFromAPI() {
            try {
                // Show loading states
                showLoadingState('classCoursesContainer', 'Loading class courses...');
                showLoadingState('subjectCoursesContainer', 'Loading subject courses...');

                // Fetch courses from API
                const response = await fetch(`${API_BASE_URL}/courses`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check response structure
                if (data.courses) {
                    allCourses = data.courses;
                } else if (Array.isArray(data)) {
                    allCourses = data;
                } else {
                    allCourses = [];
                }
                
                // Filter active courses
                allCourses = allCourses.filter(course => {
                    const isActive = 
                        course.is_active === true ||
                        course.isActive === true ||
                        course.status === 'published' ||
                        course.status === 'active' ||
                        (course.is_active !== false && course.isActive !== false);
                    return isActive;
                });
                
                // Initial filter
                filteredCourses = [...allCourses];
                
                // Separate courses by type
                const classCourses = allCourses.filter(course => 
                    course.type === 'class' || course.class_level
                );
                
                const subjectCourses = allCourses.filter(course => 
                    course.type === 'subject' || course.subject
                );
                
                // Render separated courses
                renderSeparatedCourses(classCourses, subjectCourses);
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error("Error loading courses from API:", error);
                showErrorState('classCoursesContainer', 'Error loading courses', error.message);
                showErrorState('subjectCoursesContainer', 'Error loading courses', error.message);
            }
        }

        // Render separated courses
        function renderSeparatedCourses(classCourses, subjectCourses) {
            const classContainer = document.getElementById('classCoursesContainer');
            const subjectContainer = document.getElementById('subjectCoursesContainer');
            
            // Render class courses
            if (classCourses.length === 0) {
                classContainer.innerHTML = createEmptyState('No class courses available yet');
            } else {
                classContainer.innerHTML = classCourses.map(course => 
                    createCourseCard(course, course._id || course.id)
                ).join('');
            }
            
            // Render subject courses
            if (subjectCourses.length === 0) {
                subjectContainer.innerHTML = createEmptyState('No subject courses available yet');
            } else {
                subjectContainer.innerHTML = subjectCourses.map(course => 
                    createCourseCard(course, course._id || course.id)
                ).join('');
            }
        }

        // Render all courses (for filtered view)
        function renderCourses() {
            const classContainer = document.getElementById('classCoursesContainer');
            const subjectContainer = document.getElementById('subjectCoursesContainer');
            
            if (filteredCourses.length === 0) {
                const emptyHTML = createEmptyState('No courses match your search');
                classContainer.innerHTML = emptyHTML;
                subjectContainer.innerHTML = emptyHTML;
                return;
            }
            
            // Separate filtered courses
            const classCourses = filteredCourses.filter(course => 
                course.type === 'class' || course.class_level
            );
            
            const subjectCourses = filteredCourses.filter(course => 
                course.type === 'subject' || course.subject
            );
            
            // Render
            renderSeparatedCourses(classCourses, subjectCourses);
        }

        // Create course card
        // Enhanced Create Course Card Function
        function createCourseCard(course, courseId) {
            const title = course.title || 'Untitled Course';
            const description = course.description || 'No description available';
            
            // Determine course type and category with icon
            let category = 'Course';
            let categoryIcon = 'book';
            let isClass = false;
            
            if (course.type === 'class' || course.class_level || course.classLevel) {
                category = course.class_level || course.classLevel || 'Class';
                categoryIcon = 'graduation-cap';
                isClass = true;
            } else if (course.type === 'subject' || course.subject) {
                category = course.subject || 'Subject';
                categoryIcon = 'atom';
            }
            
            const isFree = !course.price || course.price === 0;
            const price = course.price || '0';
            const lessonCount = course.lesson_count || course.lessonCount || 0;
            const duration = course.duration || 'N/A';
            const level = course.level || 'All Levels';
            
            // Get quiz and assignment counts from metadata
            const quizCount = course.metadata?.quizCount || course.metadata?.quizzes?.length || 0;
            const assignmentCount = course.metadata?.assignmentCount || course.metadata?.assignments?.length || 0;
            
            // Determine background class
            const backgroundClass = getBackgroundClass(course);
            
            // Image handling
            const hasImage = course.image_url || course.imageUrl;
            const imageUrl = course.image_url || course.imageUrl || '';
            const imageStyle = hasImage 
                ? `style="background-image: url('${imageUrl}'); background-size: cover; background-position: center;"`
                : '';
            const imageClass = hasImage ? '' : backgroundClass;
            
            // Rating stars
            const rating = course.rating || 4.5;
            const stars = generateStars(rating);
            
            // Format level for badge class
            const levelClass = level.toLowerCase().replace(/\s+/g, '-');
            
            return `
                <div class="course-card" data-course-id="${courseId}" style="animation-delay: ${Math.random() * 0.3}s">
                    <div class="course-image ${imageClass}" ${imageStyle}>
                        ${hasImage ? '<div class="image-overlay"></div>' : ''}
                        <div class="course-badges">
                            <span class="course-category">
                                <i class="fas fa-${categoryIcon}"></i> ${category}
                            </span>
                            <span class="course-badge ${isFree ? 'badge-free' : 'badge-paid'}">
                                ${isFree ? 'FREE' : '$' + price}
                            </span>
                        </div>
                    </div>
                    <div class="course-content">
                        <div class="course-header">
                            <div class="course-rating">
                                ${stars}
                                <span class="rating-value">${rating.toFixed(1)}</span>
                            </div>
                            <span class="level-badge ${levelClass}">${level}</span>
                        </div>
                        
                        <h3 class="course-title">${title}</h3>
                        <p class="course-description">${description.length > 120 ? description.substring(0, 120) + '...' : description}</p>
                        
                        <div class="course-stats">
                            ${lessonCount > 0 ? `
                                <div class="stat-item">
                                    <i class="fas fa-play-circle"></i>
                                    <span>${lessonCount} ${lessonCount === 1 ? 'Lesson' : 'Lessons'}</span>
                                </div>
                            ` : ''}
                            ${quizCount > 0 ? `
                                <div class="stat-item">
                                    <i class="fas fa-clipboard-question"></i>
                                    <span>${quizCount} ${quizCount === 1 ? 'Quiz' : 'Quizzes'}</span>
                                </div>
                            ` : ''}
                            ${assignmentCount > 0 ? `
                                <div class="stat-item">
                                    <i class="fas fa-file-invoice"></i>
                                    <span>${assignmentCount} ${assignmentCount === 1 ? 'Task' : 'Tasks'}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="course-meta-grid">
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span>${duration}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-users"></i>
                                <span>${course.enrolled_count || course.enrollmentCount || 0} enrolled</span>
                            </div>
                        </div>
                        
                        <div class="course-actions">
                            <button class="btn-primary btn-block" onclick="openCourseModal('${courseId}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${user ? `
                                <button class="btn-outline btn-block" onclick="enrollInCourse('${courseId}', ${isFree})">
                                    <i class="fas fa-plus-circle"></i> Enroll Now
                                </button>
                            ` : `
                                <a href="sign_up.html" class="btn-outline btn-block">
                                    <i class="fas fa-user-plus"></i> Sign Up to Enroll
                                </a>
                            `}
                        </div>
                        
                        ${course.updated_at || course.updatedAt ? `
                            <div class="course-footer">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Updated ${formatDate(course.updated_at || course.updatedAt)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }


        // Generate star rating HTML
        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'recently';
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'today';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }

        // Get background class
        function getBackgroundClass(course) {
            if (course.type === 'class' || course.class_level) {
                const classLevel = course.class_level || '';
                switch(classLevel.toUpperCase()) {
                    case 'SS1': return 'ss1-bg';
                    case 'SS2': return 'ss2-bg';
                    case 'SS3': return 'ss3-bg';
                    default: return 'math-bg';
                }
            } else {
                const subject = (course.subject || '').toLowerCase();
                switch(subject) {
                    case 'mathematics':
                    case 'math': return 'math-bg';
                    case 'physics': 
                    case 'chemistry': 
                    case 'biology': return 'science-bg';
                    case 'english language': 
                    case 'english': return 'english-bg';
                    case 'history':
                    case 'government': 
                    case 'geography': return 'history-bg';
                    case 'economics':
                    case 'commerce': return 'economics-bg';
                    default: return 'general-bg';
                }
            }
        }

        // Loading state
        function showLoadingState(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // Empty state
        function createEmptyState(message) {
            return `
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    <p>${message}</p>
                    <button class="btn-outline" onclick="filterCourses('all')">
                        View All Courses
                    </button>
                </div>
            `;
        }

        // Error state
        function showErrorState(containerId, title, error) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${title}</p>
                        <p style="font-size: 0.9rem; opacity: 0.7;">${error}</p>
                        <button class="btn-outline" onclick="loadCoursesFromAPI()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalCourses').textContent = allCourses.length;
            const freeCount = allCourses.filter(course => !course.price || course.price === 0).length;
            document.getElementById('freeCourses').textContent = freeCount;
            
            // Simulate active students (in real app, fetch from API)
            // const activeStudents = Math.floor(Math.random() * 1000) + 500;
            // document.getElementById('activeStudents').textContent = activeStudents.toLocaleString();
        }

        // Modal functions (from old page)
        window.openCourseModal = async function(courseId) {
            try {
                const modal = document.getElementById('courseModal');
                const backdrop = document.getElementById('modalBackdrop');
                const closeBtn = document.getElementById('modalCloseBtn');

                // Show modal skeleton
                showModalSkeleton();

                // Fetch course details
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}`);
                if (!response.ok) throw new Error('Course not found');
                
                const course = await response.json();
                
                // Populate modal with course data
                populateModal(course, courseId);

                // Show modal
                modal.classList.add('show');
                modal.setAttribute('aria-hidden', 'false');

                // Setup tab behavior
                setupModalTabs();

                // Close handlers
                backdrop.onclick = closeModal;
                closeBtn.onclick = closeModal;
                document.addEventListener('keydown', escCloseHandler);

            } catch (error) {
                console.error('Error opening modal:', error);
                showNotification('Error loading course details', 'error');
                closeModal();
            }
        };

        function showModalSkeleton() {
            // Quick skeleton while loading
            document.getElementById('modalTitle').textContent = 'Loading...';
            document.getElementById('modalSubtitle').textContent = 'Please wait';
            document.getElementById('panelOverview').innerHTML = '<div class="spinner"></div>';
            
            const modal = document.getElementById('courseModal');
            modal.classList.add('show');
        }

        // COMPLETE FIXED VERSION - Replace the entire populateModal function in your courses.html

        function populateModal(course, courseId) {
            console.log('Full course object:', course); // Debug log
            
            // Handle different API response structures
            const courseData = course.course || course.data || course;
            console.log('Course data after extraction:', courseData);
            
            // Basic info
            const title = courseData.title || courseData.name || 'Course';
            const description = courseData.description || courseData.short_description || '';
            const longDesc = courseData.longDescription || courseData.long_description || courseData.description || 'No detailed description available.';
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSubtitle').textContent = description;
            
            // Extract all possible field variations
            const lessonCount = courseData.lessonCount || courseData.lesson_count || 
                            courseData.lessons?.length || courseData.curriculum?.length || 0;
            
            const quizCount = courseData.metadata?.quizCount || courseData.metadata?.quizzes?.length || 
                            courseData.quizCount || courseData.quiz_count || 0;
            
            const assignmentCount = courseData.metadata?.assignmentCount || courseData.metadata?.assignments?.length || 
                                courseData.assignmentCount || courseData.assignment_count || 0;
            
            const duration = courseData.duration || courseData.estimated_time || 'Self-paced';
            const level = courseData.level || courseData.difficulty || 'All Levels';
            const price = courseData.price !== undefined ? courseData.price : 0;
            const enrolled = courseData.enrollmentCount || courseData.enrollment_count || 
                            courseData.enrolled_count || courseData.students || 0;
            
            const rating = courseData.rating || courseData.average_rating || 4.5;
            
            // Meta info
            document.getElementById('modalLessons').innerHTML = 
                `<i class="fas fa-play-circle"></i> ${lessonCount} ${lessonCount === 1 ? 'Lesson' : 'Lessons'}`;
            document.getElementById('modalDuration').innerHTML = 
                `<i class="fas fa-clock"></i> ${duration}`;
            document.getElementById('modalLevel').innerHTML = 
                `<i class="fas fa-user-graduate"></i> ${level}`;
            
            // Price display
            const priceEl = document.getElementById('modalPrice');
            if (price && price > 0) {
                priceEl.textContent = `$${price}`;
                priceEl.classList.remove('free');
            } else {
                priceEl.textContent = 'Free';
                priceEl.classList.add('free');
            }
            
            // Image
            const imageEl = document.getElementById('modalImage');
            const imageUrl = courseData.imageUrl || courseData.image_url || courseData.thumbnail || courseData.image;
            
            if (imageUrl) {
                imageEl.style.backgroundImage = `url('${imageUrl}')`;
                imageEl.style.backgroundSize = 'cover';
                imageEl.style.backgroundPosition = 'center';
            } else {
                // Fallback gradient
                const bgClass = getBackgroundClass(courseData);
                const gradients = {
                    'math': 'linear-gradient(135deg,#4361ee,#3a0ca3)',
                    'science': 'linear-gradient(135deg,#4cc9f0,#3f37c9)',
                    'english': 'linear-gradient(135deg,#f72585,#b5179e)',
                    'ss': 'linear-gradient(135deg,#7209b7,#3a0ca3)',
                    'default': 'linear-gradient(135deg,#4895ef,#560bad)'
                };
                
                let gradient = gradients.default;
                for (let key in gradients) {
                    if (bgClass.includes(key)) {
                        gradient = gradients[key];
                        break;
                    }
                }
                imageEl.style.background = gradient;
            }
            
            // ==== OVERVIEW TAB ====
            let overviewHTML = `
                <div class="modal-content-section">
                    <h4><i class="fas fa-info-circle"></i> Course Description</h4>
                    <p style="line-height: 1.8; color: var(--text-color);">${longDesc}</p>
                </div>
            `;
            
            // Info Grid
            overviewHTML += `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="info-card-label">Lessons</div>
                        <div class="info-card-value">${lessonCount}</div>
                    </div>
            `;
            
            if (quizCount > 0) {
                overviewHTML += `
                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="fas fa-clipboard-question"></i>
                        </div>
                        <div class="info-card-label">Quizzes</div>
                        <div class="info-card-value">${quizCount}</div>
                    </div>
                `;
            }
            
            if (assignmentCount > 0) {
                overviewHTML += `
                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="info-card-label">Assignments</div>
                        <div class="info-card-value">${assignmentCount}</div>
                    </div>
                `;
            }
            
            overviewHTML += `
                    <div class="info-card">
                        <div class="info-card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="info-card-label">Students</div>
                        <div class="info-card-value">${enrolled}</div>
                    </div>
                </div>
            `;
            
            // Course Stats Summary
            overviewHTML += `
                <div class="modal-content-section">
                    <h4><i class="fas fa-chart-bar"></i> Course Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-star" style="color: #ffc107;"></i>
                                <strong>Rating</strong>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${rating.toFixed(1)}/5.0</div>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-clock" style="color: var(--primary-color);"></i>
                                <strong>Duration</strong>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${duration}</div>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-color); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-signal" style="color: var(--success-color);"></i>
                                <strong>Level</strong>
                            </div>
                            <div style="font-size: 1.2rem; font-weight: 700;">${level}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Learning Goals
            const learningGoals = courseData.learningGoals || courseData.learning_goals || 
                                courseData.objectives || courseData.what_you_learn;
            
            if (learningGoals && Array.isArray(learningGoals) && learningGoals.length > 0) {
                overviewHTML += `
                    <div class="modal-content-section">
                        <h4><i class="fas fa-bullseye"></i> What You'll Learn</h4>
                        <ul class="features-list">
                            ${learningGoals.map(goal => `
                                <li><i class="fas fa-check-circle"></i> <span>${goal}</span></li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Prerequisites
            const prereqs = courseData.prerequisites || courseData.requirements;
            if (prereqs) {
                const prereqText = Array.isArray(prereqs) ? prereqs.join(', ') : prereqs;
                if (prereqText && prereqText.length > 0) {
                    overviewHTML += `
                        <div class="modal-content-section">
                            <h4><i class="fas fa-clipboard-list"></i> Prerequisites</h4>
                            <div class="prerequisites-box">${prereqText}</div>
                        </div>
                    `;
                }
            }
            
            // Course Features
            const features = courseData.features || courseData.includes;
            if (features && Array.isArray(features) && features.length > 0) {
                overviewHTML += `
                    <div class="modal-content-section">
                        <h4><i class="fas fa-star"></i> Course Features</h4>
                        <ul class="features-list">
                            ${features.map(feature => `
                                <li><i class="fas fa-check-circle"></i> <span>${feature}</span></li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Additional Details
            const additionalDetails = [];
            const language = courseData.language || 'English';
            const hasCert = courseData.certificate || courseData.has_certificate;
            const category = courseData.category || courseData.subject || courseData.class_level || courseData.classLevel;
            
            if (language) additionalDetails.push(`<i class="fas fa-language"></i> ${language === 'en' ? 'English' : language}`);
            if (hasCert) additionalDetails.push(`<i class="fas fa-certificate"></i> Certificate included`);
            if (category) additionalDetails.push(`<i class="fas fa-tag"></i> ${category}`);
            
            if (additionalDetails.length > 0) {
                overviewHTML += `
                    <div class="modal-content-section">
                        <h4><i class="fas fa-info"></i> Additional Information</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.75rem;">
                            ${additionalDetails.map(detail => `
                                <span style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-color); border-radius: 20px; border: 1px solid var(--border-color);">
                                    ${detail}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('panelOverview').innerHTML = overviewHTML;
            
            // ==== CURRICULUM TAB ====
            const curriculum = courseData.curriculum || courseData.lessons || courseData.syllabus || [];
            
            if (curriculum && curriculum.length > 0) {
                let curriculumHTML = `
                    <div class="modal-content-section">
                        <p style="margin-bottom: 1.5rem; color: #666;">
                            This course includes <strong>${curriculum.length}</strong> comprehensive ${curriculum.length === 1 ? 'lesson' : 'lessons'} covering all essential topics.
                        </p>
                        <div class="curriculum-list">
                `;
                
                curriculum.forEach((item, index) => {
                    const itemTitle = item.title || item.name || `Lesson ${index + 1}`;
                    const itemDesc = item.description || item.summary || '';
                    const itemDuration = item.duration || item.length || '';
                    const itemVideo = item.videoUrl || item.video_url || item.video || item.hasVideo;
                    const itemFree = item.isFree || item.is_free || item.preview;
                    
                    curriculumHTML += `
                        <div class="curriculum-item">
                            <div class="lesson-number">${index + 1}</div>
                            <div class="lesson-info">
                                <h5>${itemTitle}</h5>
                                ${itemDesc ? `<p>${itemDesc}</p>` : ''}
                                <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                    ${itemDuration ? `
                                        <span class="lesson-duration">
                                            <i class="fas fa-clock"></i> ${itemDuration}
                                        </span>
                                    ` : ''}
                                    ${itemVideo ? `
                                        <span class="lesson-duration">
                                            <i class="fas fa-video"></i> Video lesson
                                        </span>
                                    ` : ''}
                                    ${itemFree ? `
                                        <span class="lesson-duration" style="background: #d1fae5; color: #065f46; border-color: #065f46;">
                                            <i class="fas fa-unlock"></i> Free preview
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                curriculumHTML += `
                        </div>
                    </div>
                `;
                
                document.getElementById('panelCurriculum').innerHTML = curriculumHTML;
            } else {
                document.getElementById('panelCurriculum').innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: #666;">
                        <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Detailed curriculum will be available soon.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">This course is currently being developed.</p>
                    </div>
                `;
            }
            
            // ==== INSTRUCTOR TAB ====
            const instructor = courseData.instructor || courseData.tutor || courseData.teacher || courseData.author;
            
            if (instructor && typeof instructor === 'object') {
                const instName = instructor.name || instructor.full_name || 'Course Instructor';
                const instTitle = instructor.title || instructor.role || instructor.position || 'Professional Educator';
                const instBio = instructor.bio || instructor.description || instructor.about || 'Experienced educator dedicated to student success.';
                const instAvatar = instructor.avatar || instructor.photo || instructor.image;
                const instQual = instructor.qualifications || instructor.credentials;
                const instExp = instructor.experience || instructor.years_experience;
                
                let instructorHTML = `
                    <div class="instructor-card">
                        <div class="instructor-header">
                            <div class="instructor-avatar">
                `;
                
                if (instAvatar) {
                    instructorHTML += `<img src="${instAvatar}" alt="${instName}">`;
                } else {
                    instructorHTML += `<span>${instName.charAt(0).toUpperCase()}</span>`;
                }
                
                instructorHTML += `
                            </div>
                            <div class="instructor-info">
                                <h4>${instName}</h4>
                                <p>${instTitle}</p>
                            </div>
                        </div>
                        <p style="margin: 1.5rem 0; line-height: 1.8;">${instBio}</p>
                `;
                
                if (instQual) {
                    instructorHTML += `
                        <div class="modal-content-section">
                            <h5><i class="fas fa-award"></i> Qualifications</h5>
                            <p>${instQual}</p>
                        </div>
                    `;
                }
                
                if (instExp) {
                    instructorHTML += `
                        <div class="modal-content-section">
                            <h5><i class="fas fa-briefcase"></i> Experience</h5>
                            <p>${typeof instExp === 'number' ? `${instExp}+ years of teaching experience` : instExp}</p>
                        </div>
                    `;
                }
                
                instructorHTML += `</div>`;
                document.getElementById('panelInstructor').innerHTML = instructorHTML;
            } else {
                document.getElementById('panelInstructor').innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: #666;">
                        <i class="fas fa-user-tie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Instructor information will be available soon.</p>
                    </div>
                `;
            }
            
            // ==== REVIEWS TAB ====
            const reviews = courseData.reviews || courseData.testimonials || courseData.feedback || [];
            
            if (reviews && reviews.length > 0) {
                let reviewsHTML = `
                    <div class="modal-content-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <h3 style="margin: 0; font-size: 2rem;">${rating.toFixed(1)} <span style="font-size: 1rem; color: #666; font-weight: normal;">out of 5</span></h3>
                                <div class="course-rating" style="margin-top: 0.5rem;">
                                    ${generateStars(rating)}
                                    <span style="margin-left: 0.5rem; color: #666;">${reviews.length} ${reviews.length === 1 ? 'review' : 'reviews'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="reviews-list">
                `;
                
                reviews.forEach(review => {
                    const reviewerName = review.user_name || review.name || review.student_name || 'Anonymous';
                    const reviewRating = review.rating || 5;
                    const reviewComment = review.comment || review.review || review.text || 'Great course!';
                    const reviewDate = review.date || review.created_at || review.timestamp;
                    
                    reviewsHTML += `
                        <div class="review-item">
                            <div class="review-header">
                                <div class="reviewer-info">
                                    <div class="reviewer-avatar">${reviewerName.charAt(0).toUpperCase()}</div>
                                    <div>
                                        <h5>${reviewerName}</h5>
                                        <div class="review-rating">
                                            ${generateStars(reviewRating)}
                                            ${reviewDate ? `<span>${formatDate(reviewDate)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p>${reviewComment}</p>
                        </div>
                    `;
                });
                
                reviewsHTML += `
                        </div>
                    </div>
                `;
                
                document.getElementById('panelReviews').innerHTML = reviewsHTML;
            } else {
                document.getElementById('panelReviews').innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: #666;">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No reviews yet. Be the first to review this course!</p>
                        ${user ? `
                            <button class="btn-primary" style="margin-top: 1.5rem;" onclick="alert('Review feature coming soon!')">
                                <i class="fas fa-star"></i> Write a Review
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            
            // Action button
            const actionBtn = document.getElementById('modalAction');
            if (user) {
                actionBtn.innerHTML = `<i class="fas fa-${price && price > 0 ? 'shopping-cart' : 'play-circle'}"></i> ${price && price > 0 ? 'Enroll Now' : 'Start Learning'}`;
                actionBtn.href = `course.html?id=${courseId}`;
            } else {
                actionBtn.innerHTML = '<i class="fas fa-user-plus"></i> Sign Up to Enroll';
                actionBtn.href = 'sign_up.html';
            }
        }

        function setupModalTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const panels = document.querySelectorAll('.tab-panel');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Set active button
                    tabBtns.forEach(b => {
                        b.classList.toggle('active', b === btn);
                        b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
                    });
                    
                    // Show corresponding panel
                    panels.forEach(panel => {
                        const shouldShow = panel.dataset.panel === btn.dataset.tab;
                        panel.hidden = !shouldShow;
                        panel.classList.toggle('active', shouldShow);
                    });
                    
                    btn.focus();
                });
            });
        }

        window.closeModal = function() {
            const modal = document.getElementById('courseModal');
            if (modal) {
                modal.classList.remove('show');
                document.removeEventListener('keydown', escCloseHandler);
            }
        }

        function escCloseHandler(e) {
            if (e.key === 'Escape') closeModal();
        }

        // Enroll in course
        window.enrollInCourse = async function(courseId, isFree) {
            if (!user) {
                window.location.href = 'sign_in.html';
                return;
            }
            
            if (!isFree) {
                showNotification('Payment integration would be implemented here!', 'info');
                return;
            }
            
            // Simulate enrollment
            showNotification('Successfully enrolled in the course!', 'success');
            
            // In real app, call API to enroll
            // await fetch(`${API_BASE_URL}/enroll`, {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ userId: user.id, courseId })
            // });
        }

        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS for notification animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>