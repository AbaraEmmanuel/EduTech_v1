<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaroMind - Explore Courses</title>
    <link rel="stylesheet" href="notification.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="courses.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="light-mode">

    <nav class="navbar">
        <div class="navbar-left">
            <img src="ht9.png" class="logo_img">
            <a href="index.html" class="nav-link">JaroMind</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="courses.html" class="nav-link active">Courses</a>
        </div>
        <div class="navbar-right">
            <button class="mode-toggle" id="modeToggle">ðŸŒž</button>
            <div class="auth-buttons">
                <a href="sign_in.html" class="btn-outline">Login</a>
                <a href="sign_up.html" class="btn-primary">Sign Up</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="courses-header">
            <h1>Explore Our Courses</h1>
            <p>Browse our collection of courses. Sign up to enroll and start learning!</p>
        </div>

        <!-- Course Categories Filter -->
        <div class="filter-container">
            <button class="filter-btn active" data-filter="all">All Courses</button>
            <button class="filter-btn" data-filter="class">Class Lessons</button>
            <button class="filter-btn" data-filter="subject">Subject Lessons</button>
            <button class="filter-btn" data-filter="free">Free Courses</button>
        </div>

        <!-- Courses Grid -->
        <div class="courses-grid" id="coursesContainer">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading courses...</p>
            </div>
        </div>

        <!-- Call to Action -->
        <div class="cta-section">
            <h2>Ready to Start Learning?</h2>
            <p>Sign up now to enroll in courses and track your progress</p>
            <a href="sign_up.html" class="btn-primary btn-large">Get Started Free</a>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://jaromind-production-014b.up.railway.app';
        // For local testing: const API_BASE_URL = 'http://localhost:8080';

        // Global variables
        let allCourses = [];
        let filteredCourses = [];

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Theme Management
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            document.body.className = savedTheme;
            updateModeIcon(savedTheme);

            // Mode toggle
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle) {
                modeToggle.addEventListener('click', toggleTheme);
            }

            // Filter buttons
            setupFilterButtons();

            // Load courses
            loadCoursesFromAPI();
        });

        // Theme functions
        function toggleTheme() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.replace('light-mode', 'dark-mode');
                localStorage.setItem('theme', 'dark-mode');
                updateModeIcon('dark-mode');
            } else {
                document.body.classList.replace('dark-mode', 'light-mode');
                localStorage.setItem('theme', 'light-mode');
                updateModeIcon('light-mode');
            }
        }

        function updateModeIcon(theme) {
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle) {
                modeToggle.textContent = theme === 'dark-mode' ? 'ðŸŒ™' : 'ðŸŒž';
            }
        }

        // Filter functions
        function setupFilterButtons() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Filter courses
                    const filter = btn.dataset.filter;
                    filterCourses(filter);
                });
            });
        }

        function filterCourses(filter) {
            if (filter === 'all') {
                filteredCourses = [...allCourses];
            } else if (filter === 'free') {
                filteredCourses = allCourses.filter(course => !course.price || course.price === 0);
            } else if (filter === 'class') {
                filteredCourses = allCourses.filter(course => course.type === 'class' || course.class_level);
            } else if (filter === 'subject') {
                filteredCourses = allCourses.filter(course => course.type === 'subject' || course.subject);
            }
            
            renderCourses();
        }

        // API functions
        async function loadCoursesFromAPI() {
            try {
                const coursesContainer = document.getElementById('coursesContainer');
                
                // Show loading state
                showLoadingState(coursesContainer, 'Loading courses...');

                // Fetch courses from API
                const response = await fetch(`${API_BASE_URL}/courses`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                allCourses = data.courses || [];
                
                if (allCourses.length === 0) {
                    showEmptyState(coursesContainer, 'No courses available yet');
                    return;
                }

                // Filter out inactive courses
                allCourses = allCourses.filter(course => course.is_active);
                
                // Initial filter
                filteredCourses = [...allCourses];
                
                // Render courses
                renderCourses();
                
            } catch (error) {
                console.error("Error loading courses from API:", error);
                showErrorState('coursesContainer', 'Error loading courses', error.message);
            }
        }

        function showLoadingState(container, message) {
            container.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        function showEmptyState(container, message) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    <p>${message}</p>
                    <p>Check back soon for new courses!</p>
                </div>
            `;
        }

        function showErrorState(containerId, title, error) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${title}</p>
                        <p>${error}</p>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }

        function renderCourses() {
            const container = document.getElementById('coursesContainer');
            
            if (filteredCourses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No courses match your filter</p>
                        <p>Try a different filter or check back soon</p>
                    </div>
                `;
                return;
            }

            let coursesHTML = '';
            
            filteredCourses.forEach((course) => {
                const courseId = course._id || course.id;
                coursesHTML += createCourseCard(course, courseId);
            });

            container.innerHTML = coursesHTML;
        }

        function createCourseCard(course, courseId) {
            // Extract course data with fallbacks
            const title = course.title || 'Untitled Course';
            const description = course.description || 'No description available';
            
            // Determine course type
            let category = 'Course';
            if (course.type === 'class' || course.class_level) {
                category = course.class_level || 'Class';
            } else if (course.type === 'subject' || course.subject) {
                category = course.subject || 'Subject';
            }
            
            const isFree = !course.price || course.price === 0;
            const price = course.price || '0';
            const lessonCount = course.lesson_count || course.lessonCount || 10;
            const duration = course.duration || '6h';
            const level = course.level || 'All Levels';
            
            // Determine background class
            const backgroundClass = getBackgroundClass(course);
            
            // Image handling
            const hasImage = course.image_url || course.imageUrl;
            const imageUrl = course.image_url || course.imageUrl || '';
            const imageStyle = hasImage 
                ? `style="background-image: url('${imageUrl}'); background-size: cover; background-position: center;"`
                : '';
            const imageClass = hasImage ? '' : backgroundClass;
            
            return `
                <div class="course-card">
                    <div class="course-image ${imageClass}" ${imageStyle}>
                        ${hasImage ? '<div class="image-overlay"></div>' : ''}
                        <span class="course-category">${category}</span>
                        <span class="course-badge ${isFree ? 'badge-free' : 'badge-paid'}">
                            ${isFree ? 'FREE' : 'PAID'}
                        </span>
                    </div>
                    <div class="course-content">
                        <h3>${title}</h3>
                        <p>${description}</p>
                        
                        <div class="course-meta">
                            <span><i class="fas fa-play-circle"></i> ${lessonCount} Lessons</span>
                            <span><i class="fas fa-clock"></i> ${duration}</span>
                            <span><i class="fas fa-user-graduate"></i> ${level}</span>
                        </div>
                        
                        ${!isFree ? `
                            <div class="course-price price-paid">$${price}</div>
                        ` : `
                            <div class="course-price price-free">Free</div>
                        `}
                        
                        <div class="course-actions">
                            <button class="btn-primary" onclick="viewCourseDetails('${courseId}')">
                                View Details
                            </button>
                            <a href="sign_up.html" class="btn-outline">
                                Sign Up to Enroll
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBackgroundClass(course) {
            if (course.type === 'class' || course.class_level) {
                const classLevel = course.class_level || '';
                switch(classLevel.toUpperCase()) {
                    case 'SS1': return 'ss1-bg';
                    case 'SS2': return 'ss2-bg';
                    case 'SS3': return 'ss3-bg';
                    default: return 'math-bg';
                }
            } else {
                const subject = (course.subject || '').toLowerCase();
                switch(subject) {
                    case 'mathematics':
                    case 'math': return 'math-bg';
                    case 'physics': 
                    case 'chemistry': 
                    case 'biology': return 'science-bg';
                    case 'english language': 
                    case 'english': return 'english-bg';
                    case 'history':
                    case 'government': return 'history-bg';
                    default: return 'general-bg';
                }
            }
        }

        // Global functions
        window.viewCourseDetails = async function(courseId) {
            try {
                // Fetch course details from API
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}`);
                
                if (!response.ok) {
                    throw new Error('Course not found');
                }
                
                const course = await response.json();
                
                // Create and show modal
                showCourseModal(course, courseId);
                
            } catch (error) {
                console.error("Error loading course details:", error);
                showNotification('Error loading course details: ' + error.message, 'error');
            }
        }

        function showCourseModal(course, courseId) {
            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="courseModalOverlay">
                    <div class="modal-container">
                        <div class="modal-header">
                            <h2>${course.title || 'Course Details'}</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${course.image_url ? `
                                <div class="modal-image">
                                    <img src="${course.image_url}" alt="${course.title}">
                                </div>
                            ` : ''}
                            
                            <div class="modal-content">
                                <p><strong>Description:</strong> ${course.description || 'No description available'}</p>
                                
                                <div class="course-details-grid">
                                    ${course.subject ? `
                                        <div class="detail-item">
                                            <i class="fas fa-book"></i>
                                            <span>Subject: ${course.subject}</span>
                                        </div>
                                    ` : ''}
                                    
                                    ${course.class_level ? `
                                        <div class="detail-item">
                                            <i class="fas fa-graduation-cap"></i>
                                            <span>Class Level: ${course.class_level}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="detail-item">
                                        <i class="fas fa-play-circle"></i>
                                        <span>Lessons: ${course.lesson_count || course.lessonCount || 10}</span>
                                    </div>
                                    
                                    ${course.duration ? `
                                        <div class="detail-item">
                                            <i class="fas fa-clock"></i>
                                            <span>Duration: ${course.duration}</span>
                                        </div>
                                    ` : ''}
                                    
                                    ${course.level ? `
                                        <div class="detail-item">
                                            <i class="fas fa-user-graduate"></i>
                                            <span>Level: ${course.level}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${course.price ? `
                                    <div class="price-display">
                                        <strong>Price: $${course.price}</strong>
                                    </div>
                                ` : `
                                    <div class="price-display free">
                                        <strong>This course is FREE!</strong>
                                    </div>
                                `}

                                <div class="modal-actions">
                                    <a href="sign_up.html" class="btn-primary">
                                        Sign Up to Enroll
                                    </a>
                                    <button class="btn-outline" onclick="closeModal()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv.firstElementChild);
            
            // Add close on overlay click
            const overlay = document.getElementById('courseModalOverlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target.id === 'courseModalOverlay') {
                        closeModal();
                    }
                });
            }
        }

        window.closeModal = function() {
            const modal = document.getElementById('courseModalOverlay');
            if (modal) {
                modal.remove();
            }
        }

        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 5px;
                background: ${type === 'error' ? '#f44336' : '#4361ee'};
                color: white;
                z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>